{% extends "dsmr_frontend/base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load i18n %} 

{% block title %}{% trans "Dashboard" %}{% endblock %}
{% block header %}{% trans "Dashboard" %} &nbsp; <i class="fa fa-dashboard"></i>{% endblock %}

{% block content %}
<!-- Main content -->
<section class="content">
{% if not latest_electricity %}
    <div class="alert alert-danger" role="alert">
        <span class="fa fa-exclamation fa-2x"></span> {% blocktrans %}No data found. Please make sure the datalogger is up and running and the backend process is running as well.{% endblocktrans %}
    </div>
{% endif %}

    {% if month_statistics %}
    <div class="row consumption-block">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% trans "This month" %} <small>({% trans "until yesterday" %})</small>
                </header>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th class="col-md-6"></th>
                            <th class="col-md-2">{% trans "Delivered" %} ({% trans "kWh" noop %} / {% trans "m<sup>3</sup>" noop %})</th>
                            <th class="col-md-2">{% trans "Returned" %} ({% trans "kWh" noop %})</th>
                            <th class="col-md-2">{% trans "Cost" %} (&euro;)</th>
                        </tr>
                        <tr>
                            <td>{% trans "Electricity 1 (off-peak)" %}</td>
                            <td><span class="badge bg-red">{{ month_statistics.total_electricity1|default:'-' }} </span></td>
                            <td><span class="badge bg-green">{{ month_statistics.total_electricity1_returned|default:'-' }}</span></td>
                            <td><span class="badge bg-black">{{ month_statistics.total_electricity1_cost|default:'-' }}</span></td>
                        </tr>
                        <tr>
                            <td>{% trans "Electricity 2 (peak)" %}</td>
                            <td><span class="badge bg-red">{{ month_statistics.total_electricity2|default:'-' }}</span></td>
                            <td><span class="badge bg-green">{{ month_statistics.total_electricity2_returned|default:'-' }}</span></td>
                            <td><span class="badge bg-black">{{ month_statistics.total_electricity2_cost|default:'-' }}</span></td>
                        </tr>
                        {% if month_statistics.total_gas %}
                        <tr>
                            <td>{% trans "Gas" %}</td>
                            <td><span class="badge bg-orange">{{ month_statistics.total_gas|default:'-' }}</span></td>
                            <td>&nbsp;</td>
                            <td><span class="badge bg-black">{{ month_statistics.total_gas_cost|default:'-' }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="font-weight: bold;">{% trans "Total" %}</td>
                            <td colspan="2">&nbsp;</td>
                            <td>
	                            <span class="badge bg-black">
	                                {{ month_statistics.total_cost }}
	                            </span>
                            </td>
                        </tr>
                    </table>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
    {% endif %}

	{% if consumption %}
    <div class="row consumption-block">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {{ consumption.day }}
                </header>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th class="col-md-6"></th>
                            <th class="col-md-2">{% trans "Delivered" %} ({% trans "kWh" noop %} / {% trans "m<sup>3</sup>" noop %})</th>
                            <th class="col-md-2">{% trans "Returned" %} ({% trans "kWh" noop %})</th>
                            <th class="col-md-2">{% trans "Cost" %} (&euro;)</th>
                        </tr>
                        <tr>
                            <td>{% trans "Electricity 1 (off-peak)" %}</td>
                            <td><span class="badge bg-red">{{ consumption.electricity1|default:'-' }} </span></td>
                            <td><span class="badge bg-green">{{ consumption.electricity1_returned|default:'-' }}</span></td>
                            <td><span class="badge bg-black">{{ consumption.electricity1_cost|default:'-' }}</span></td>
                        </tr>
                        <tr>
                            <td>{% trans "Electricity 2 (peak)" %}</td>
                            <td><span class="badge bg-red">{{ consumption.electricity2|default:'-' }}</span></td>
                            <td><span class="badge bg-green">{{ consumption.electricity2_returned|default:'-' }}</span></td>
                            <td><span class="badge bg-black">{{ consumption.electricity2_cost|default:'-' }}</span></td>
                        </tr>
                        {% if consumption.gas %}
                        <tr>
                            <td>{% trans "Gas" %}</td>
                            <td><span class="badge bg-orange">{{ consumption.gas|default:'-' }}</span></td>
                            <td>&nbsp;</td>
                            <td><span class="badge bg-black">{{ consumption.gas_cost|default:'-' }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="font-weight: bold;">{% trans "Total" %}</td>
                            <td colspan="2">&nbsp;</td>
                            <td><span class="badge bg-black">{{ consumption.total_cost|default:'-' }}</span></td>
                        </tr>
                    </table>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
	{% endif %}

    {% if latest_electricity_read %}
    <div class="row">
        <div class="col-md-{% if latest_electricity_returned %}4{% else %}6{% endif %}">
            <div class="panel">
                <header class="panel-heading">
                    {{ latest_electricity_read|naturaltime }}
                </header>
                <div class="panel-body">
                    <span class="sm-st-icon st-red"><i class="fa fa-bolt"></i></span>
                    <div class="sm-st-info">
                        <span>{{ latest_electricity }}</span>
                        {% trans "Watt consumed" %}
                    </div>
                </div>
            </div>
        </div>
        
        {% if latest_electricity_returned %}
        <div class="col-md-4">
            <div class="panel">
                <header class="panel-heading">
                    {{ latest_electricity_read|naturaltime }}
                </header>
                <div class="panel-body">
                    <span class="sm-st-icon bg-green"><i class="fa fa-bolt"></i></span>
                    <div class="sm-st-info">
                        <span>{{ latest_electricity_returned|default:'-' }}</span>
                        {% trans "Watt returned" %}
                    </div>
                </div>
            </div>       
        </div>
        {% endif %}
        
        {% if latest_gas_read %}
        <div class="col-md-{% if latest_electricity_returned %}4{% else %}6{% endif %}">
            <div class="panel">
                <header class="panel-heading">
                    {{ latest_gas_read|naturaltime }}
                </header>
                <div class="panel-body">
                    <span class="sm-st-icon st-orange"><i class="fa fa-fire"></i></span>
                    <div class="sm-st-info">
                        <span>{{ latest_gas }}</span>
                        {% trans "m<sup>3</sup> gas consumed in hour" %}
                    </div>
                </div>
            </div> 
        </div>
        {% endif %}
    </div><!-- /.row -->
    {% endif %}
	
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% trans "Recent electricity delivered (watt)" %}
                </header>
                <div class="panel-body">
                	<canvas id="electricity-chart" height="200"></canvas>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->

    {% if consumption and consumption.gas %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% trans "Recent gas delivered (m<sup>3</sup>)" %}
                </header>
                <div class="panel-body">
			        <canvas id="gas-chart" height="200"></canvas>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
    {% endif %}
    
    {% if temperature_count %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% trans "Recent temperatures (&deg;C)" %}
                </header>
                <div class="panel-body">
                {% if track_temperature %}
                    <canvas id="temperature-chart" height="200"></canvas>
                {% else %}
                    <div class="alert alert-info" role="alert">
                    {% blocktrans %}Weather tracking is currently disabled. Enable this feature in weather settings to view temperatures (read hourly).{% endblocktrans %}
                    </div>
                {% endif %}
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
    {% endif %}
</section><!-- /.content -->
{% endblock %}


{% block javascript %}
{{ block.super }}
        <script type="text/javascript" src="{% static 'dsmr_frontend/js/chartjs/Chart.min.js' %}"></script>
        <script type="text/javascript">
	        var line_options = {
	            /* Not available globally, but it fixes duplicate tooltips being triggered by x-axis data points close to each other. */
	            pointHitDetectionRadius: 3,
                pointDotRadius: 2.5,
	        }
        
        	$(document).ready(function(){
                Chart.defaults.global.responsive = true;
                Chart.defaults.global.maintainAspectRatio = false;
                Chart.defaults.global.animation = false;
                Chart.defaults.global.segmentShowStroke = true;
                
                render_electricity_chart();
                render_gas_chart();

                {% if track_temperature %}
                render_temperature_chart();
                {% endif %}
        	});
        	
		   	function render_electricity_chart()
		   	{
		   		var data = {
	   				labels: {{ electricity_x|safe }},
	   				datasets: [{
	   					data: {{ electricity_y|safe }},
	   					label: "{% trans 'Electricity' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(255,0,0,1)",
	   					pointColor: "rgba(255,0,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(255,0,0,1)"
	   				}]
	   			};
	
	   			var ctx = $("#electricity-chart").get(0).getContext("2d");
	   			new Chart(ctx).Line(data, line_options);
   			}
		   	
		   	function render_gas_chart()
		   	{
		   		var data = {
	   				labels: {{ gas_x|safe }},
	   				datasets: [{
	   					data: {{ gas_y|safe }},
	   					label: "{% trans 'Gas' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(250,133,0,1)",
	   					pointColor: "rgba(250,133,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(150,150,150,1)"
	   				}]
	   			};

	   			var ctx = $("#gas-chart").get(0).getContext("2d");
	   			new Chart(ctx).Line(data, line_options);
   			}

	    {% if track_temperature %}
            function render_temperature_chart()
            {
                var data = {
                    labels: {{ temperature_x|safe }},
                    datasets: [{
                        data: {{ temperature_y|safe }},
                        label: "{% trans 'Temperature' %}",                       
                        fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(35,183,229,1)",
                        pointColor: "rgba(35,183,229,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(150,150,150,1)"
                    }]
                };

                var ctx = $("#temperature-chart").get(0).getContext("2d");
                new Chart(ctx).Line(data, line_options);
            }
        {% endif %}
		</script>

{% endblock %}