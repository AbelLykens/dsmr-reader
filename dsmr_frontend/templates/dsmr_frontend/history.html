{% extends "dsmr_frontend/base.html" %}
{% load staticfiles %}
{% load i18n %}

{% block title %}{% trans "History" %}{% endblock %}
{% block header %}{% trans "History" %} &nbsp; <i class="fa fa-line-chart"></i>{% endblock %}

{% block content %}
<!-- Main content -->
<section class="content">
{% if not capabilities.any or not chart %}
    <div class="alert alert-danger" role="alert">
        <span class="fa fa-exclamation fa-2x"></span> {% blocktrans %}No data found. It can take up to one day before any data is visible here.{% endblocktrans %}
    </div>
{% endif %}

    {% if capabilities.any and statistics_summary %}
    <div class="row consumption-block">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Summary of past {{ days_ago }} days{% endblocktrans %}
                </header>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th class="col-md-6"></th>
                            <th class="col-md-2">{% if capabilities.electricity %}{% trans "Consumed" %} ({% trans "kWh" noop %}{% if capabilities.gas %} / {% trans "m<sup>3</sup>" noop %}{% endif %}){% endif %}</th>
                            <th class="col-md-2">{% if capabilities.electricity_returned %}{% trans "Returned" %} ({% trans "kWh" noop %}){% endif %}</th>
                            <th class="col-md-2">{% trans "Cost" %} (&euro;)</th>
                        </tr>
                        <tr>
                            <td>{% if capabilities.electricity %}{% trans "Electricity 1 (low tariff)" %}{% endif %}</td>
                            <td><span class="badge bg-red">{% if capabilities.electricity %}{{ statistics_summary.electricity1|default:'-' }} </span>{% endif %}</td>
                            <td><span class="badge bg-green">{% if capabilities.electricity_returned %}{{ statistics_summary.electricity1_returned|default:'-' }}{% endif %}</span></td>
                            <td><span class="badge bg-black">{% if capabilities.electricity %}{{ statistics_summary.electricity1_cost|default:'-' }}{% endif %}</span></td>
                        </tr>
                        <tr>
                            <td>{% if capabilities.electricity %}{% trans "Electricity 2 (high tariff)" %}{% endif %}</td>
                            <td><span class="badge bg-red">{% if capabilities.electricity %}{{ statistics_summary.electricity2|default:'-' }}{% endif %}</span></td>
                            <td><span class="badge bg-green">{% if capabilities.electricity_returned %}{{ statistics_summary.electricity2_returned|default:'-' }}{% endif %}</span></td>
                            <td><span class="badge bg-black">{% if capabilities.electricity %}{{ statistics_summary.electricity2_cost|default:'-' }}{% endif %}</span></td>
                        </tr>
                        {% if capabilities.gas %}
                        <tr>
                            <td>{% trans "Gas" %}</td>
                            <td><span class="badge bg-orange">{{ statistics_summary.gas|default:'-' }}</span></td>
                            <td>&nbsp;</td>
                            <td><span class="badge bg-black">{{ statistics_summary.gas_cost|default:'-' }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="font-weight: bold;">{% trans "Total" %}</td>
                            <td colspan="2">&nbsp;</td>
                            <td><span class="badge bg-black">{{ statistics_summary.total_cost|default:'-' }}</span></td>
                        </tr>
                    </table>                
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
    {% endif %}


{% if capabilities.any and chart %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Daily cost{% endblocktrans %} {% trans "(in &euro;)" %}
                </header>
                <div class="panel-body" style="height: 200px;">
                	<canvas id="cost-chart"></canvas>
                	<div id="cost-chart-legend"></div>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
{% endif %}

{% if capabilities.electricity and chart %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Daily electricity usage{% endblocktrans %} {% trans "(in kWh)" %}
                </header>
                <div class="panel-body" style="height: 200px;">
                	<canvas id="electricity-chart"></canvas>
                    <div id="electricity-chart-legend"></div>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
{% endif %}

{% if capabilities.electricity_returned and chart %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Daily electricity returned{% endblocktrans %} {% trans "(in kWh)" %}
                </header>
                <div class="panel-body" style="height: 200px;">
                    <canvas id="electricity-returned-chart"></canvas>
                    <div id="electricity-returned-chart-legend"></div>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
{% endif %}

{% if capabilities.gas and chart %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Daily gas usage{% endblocktrans %} {% trans "(in m<sup>3</sup>)" %}
                </header>
                <div class="panel-body" style="height: 200px;">
                	<canvas id="gas-chart"></canvas>
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
{% endif %}

{% if capabilities.weather and chart %}
    <div class="row">
        <div class="col-md-12">
            <div class="panel">
                <header class="panel-heading">
                    {% blocktrans %}Daily average temperature{% endblocktrans %} {% trans "(in &deg;C)" %}
                </header>
                <div class="panel-body" style="height: 200px;">
                {% if track_temperature %}
                    <canvas id="temperature-chart"></canvas>
                {% else %}
                    <div class="alert alert-info" role="alert">
                    {% blocktrans %}Weather tracking is currently disabled. Enable this feature in weather settings to view temperatures (read hourly).{% endblocktrans %}
                    </div>
                {% endif %}
                </div><!-- /.panel-body -->
            </div><!-- /.panel -->
        </div><!-- /.col -->
    </div><!-- /.row -->
{% endif %}
</section><!-- /.content -->
{% endblock %}

{% block javascript %}
{{ block.super }}
        <script type="text/javascript" src="{% static 'dsmr_frontend/js/chartjs/Chart.min.js' %}"></script>
        <script type="text/javascript">
            var line_options = {
                /* Not available globally, but it fixes duplicate tooltips being triggered by x-axis data points close to each other. */
                pointHitDetectionRadius: 5,
                pointDotRadius: 2.5,
                
                {% verbatim %}
                legendTemplate : "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li style=\"display: inline; margin-right: 24px; font-weight: bold;\"><span style=\"color:<%=datasets[i].strokeColor%>\"><%if(datasets[i].label){%><%=datasets[i].label%><%}%></span></li><%}%></ul>"
                {% endverbatim %}
            }
        
        	$(document).ready(function(){
                Chart.defaults.global.responsive = true;
                Chart.defaults.global.maintainAspectRatio = false;
        		Chart.defaults.global.animation = false;
        		
            {% if capabilities.any %}
        		render_cost_chart();
            {% endif %}
            
            {% if capabilities.electricity %}
                render_electricity_chart();
            {% endif %}
            
            {% if capabilities.electricity_returned %}
                render_electricity_returned_chart();
            {% endif %}
        		
       		{% if capabilities.gas %}
        		render_gas_chart();
       		{% endif %}

       		{% if capabilities.weather %}
        		render_temperature_chart();
      		{% endif %}
        	});
        	
            {% if capabilities.any %}
		   	function render_cost_chart()
		   	{
		   		var data = {
	   				labels: {{ chart.days|safe }},
	   				datasets: [{% if capabilities.electricity %}{
	   					data: {{ chart.electricity1_cost|safe }},
	   					label: "{% trans 'Electricity 1 cost (low tariff)' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(160,0,0,1)",
	   					pointColor: "rgba(160,0,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(255,0,0,1)"
	   				}, {
	   					data: {{ chart.electricity2_cost|safe }},
	   					label: "{% trans 'Electricity 2 cost (high tariff)' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(255,0,0,1)",
	   					pointColor: "rgba(255,0,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(255,0,0,1)"
	   				}{% endif %}{% if capabilities.gas %}, {
	   					data: {{ chart.gas_cost|safe }},
	   					label: "{% trans 'Gas cost' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(250,133,0,1)",
	   					pointColor: "rgba(250,133,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(150,150,150,1)"
	   				}{% endif %}, {
                        data: {{ chart.total_cost|safe }},
                        label: "{% trans 'Total cost' %}",
                        fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(0,0,0,1)",
                        pointColor: "rgba(0,0,0,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(0,0,0,1)"
                    }]
	   			};
	
	   			var ctx = $("#cost-chart").get(0).getContext("2d");
                ctx.canvas.height = $("#cost-chart").parent().height();
	   			var chart_instance = new Chart(ctx).Line(data, line_options);
	   			$("#cost-chart-legend").html(chart_instance.generateLegend());
   			}
		   	{% endif %}
		   	
		   	{% if capabilities.electricity %}
		   	function render_electricity_chart()
		   	{
		   		var data = {
	   				labels: {{ chart.days|safe }},
	   				datasets: [{
	   					data: {{ chart.electricity1|safe }},
	   					label: "{% trans 'Electricity 1 (low tariff)' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(160,0,0,1)",
	   					pointColor: "rgba(160,0,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(255,0,0,1)"
	   				}, {
	   					data: {{ chart.electricity2|safe }},
	   					label: "{% trans 'Electricity 2 (high tariff)' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
	   					strokeColor: "rgba(255,0,0,1)",
	   					pointColor: "rgba(255,0,0,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(255,0,0,1)"
	   				}]
	   			};
	
	   			var ctx = $("#electricity-chart").get(0).getContext("2d");
                ctx.canvas.height = $("#electricity-chart").parent().height();
	   			var chart_instance = new Chart(ctx).Line(data, line_options);
                $("#electricity-chart-legend").html(chart_instance.generateLegend());
   			}
		   	{% endif %}
            
            {% if capabilities.electricity_returned %}
            function render_electricity_returned_chart()
            {
                var data = {
                    labels: {{ chart.days|safe }},
                    datasets: [{
                        data: {{ chart.electricity1_returned|safe }},
                        label: "{% trans 'Electricity 1 returned (low tariff)' %}",                       
                        fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(200,200,100,1)",
                        pointColor: "rgba(200,200,100,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(200,200,100,1)"
                    }, {
                        data: {{ chart.electricity2_returned|safe }},
                        label: "{% trans 'Electricity 1 returned (high tariff)' %}",                       
                        fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(39,194,76,1)",
                        pointColor: "rgba(39,194,76,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(39,194,76,1)"
                    }]
                };
    
                var ctx = $("#electricity-returned-chart").get(0).getContext("2d");
                ctx.canvas.height = $("#electricity-returned-chart").parent().height();
                var chart_instance = new Chart(ctx).Line(data, line_options);
                $("#electricity-returned-chart-legend").html(chart_instance.generateLegend());
            }
            {% endif %}
            
            {% if capabilities.gas %}
            function render_gas_chart()
            {
                var data = {
                    labels: {{ chart.days|safe }},
                    datasets: [{
                        data: {{ chart.gas|safe }},
                        label: "{% trans 'Gas' %}",                       
                        fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(250,133,0,1)",
                        pointColor: "rgba(250,133,0,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(150,150,150,1)"
                    }]
                };

                var ctx = $("#gas-chart").get(0).getContext("2d");
                ctx.canvas.height = $("#gas-chart").parent().height();
                new Chart(ctx).Line(data, line_options);
            }
            {% endif %}
            
            {% if capabilities.weather %}
		   	function render_temperature_chart()
		   	{
		   		var data = {
	   				labels: {{ chart.days|safe }},
	   				datasets: [{
	   					data: {{ chart.average_temperature|safe }},
	   					label: "{% trans 'Temperature' %}",	       				
	   					fillColor: "rgba(255,255,255,0.2)",
                        strokeColor: "rgba(35,183,229,1)",
                        pointColor: "rgba(35,183,229,1)",
	   					pointStrokeColor: "#fff",
	   					pointHighlightFill: "#fff",
	   					pointHighlightStroke: "rgba(150,150,150,1)"
	   				}]
	   			};

	   			var ctx = $("#temperature-chart").get(0).getContext("2d");
                ctx.canvas.height = $("#temperature-chart").parent().height();
	   			new Chart(ctx).Line(data, line_options);
   			}
		    {% endif %}

		</script>
{% endblock %}