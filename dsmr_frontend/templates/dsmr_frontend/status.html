{% extends "dsmr_frontend/base.html" %}
{% load humanize %} 
{% load static %} 
{% load i18n %}

{% block title %}{% translate "Status" %}{% endblock %}
{% block header %}{% translate "Status" %} &nbsp; <i class="fas fa-heartbeat"></i>{% endblock %}

{% block content %}
<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-cube"></i> &nbsp; {% translate "Application" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="col-sm-6">{% translate "Current version" %}</td>
                            <td class="col-sm-6"><a href="https://dsmr-reader.readthedocs.io/{{ LANGUAGE_CODE }}/v4/changelog.html" target="_blank" title="{% translate 'View releases' %}"><i class="fas fa-external-link-alt"></i> v{{ dsmr_version }}</a></td>
                        </tr>
                        <tr>
                            <td class="col-sm-6">
                                {% translate "Check for updates" %}
                                <br><br>
                                
                                <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                <small class="xhr-hidden">{% blocktranslate %}The application will compare "VERSION = (x,x,x)" in your local dsmrreader/__init__.py file with the latest one available on Github.{% endblocktranslate %}</small>
                            </td>
                            <td class="col-sm-6">
                                <a class="btn btn-success" href="#" id="check_for_updates"><i class="fas fa-sync"></i> &nbsp; {% translate 'Check now' %}</a>
                                <div id="loader" class="xhr-hidden"><i class="fas fa-circle-notch fa-spin fa-fw"></i> &nbsp; {% translate 'Currently checking for updates...' %}</div>
                                <div id="update_available" class="alert alert-warning xhr-hidden" role="alert">
	                                <i class="fas fa-exclamation"></i> &nbsp; {% blocktranslate %}There is a newer version available!{% endblocktranslate %}
	                                <a href="https://github.com/dennissiemensma/dsmr-reader/releases" target="_blank">{% translate 'View the latest release' %}</a> {% translate 'for the changelog and further upgrade instructions.' %}
	                            </div>
                                <div id="no_update_available" class="alert alert-success xhr-hidden" role="alert"><i class="fas fa-check"></i> &nbsp; {% blocktranslate %}You are already running the latest version released.{% endblocktranslate %}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-plug"></i> &nbsp; {% translate "Telegrams" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Incoming telegrams/readings" %}</strong>
                                <br><br>

                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}The telegrams are either read from the DSMR_DATALOGGER process or received by the API.{% endblocktranslate %}
                                        {% blocktranslate %}Each telegram read from your smart meter is stored and queued for processing first.{% endblocktranslate %}
                                        {% blocktranslate %}Each new telegram is (only) used to display the latest reading, in the top right corner of the Dashboard page.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if status.readings.seconds_since == None or status.readings.seconds_since > 90 %}
                                <div class="alert alert-danger" role="alert">
                                    <span class="fas fa-exclamation-triangle"></span> &nbsp;
                                    {% blocktranslate %}It has been a while since the latest telegram was read.{% endblocktranslate %}
                                    <br /><br />
                                {% else %}
                                <div class="alert alert-success" role="alert">
                                    <span class="fas fa-check"></span> &nbsp;
                                {% endif %}
                                    {% translate "Most recent reading" %}:
                                    <strong>{% if status.readings.latest %}{{ status.readings.latest|naturaltime }}{% else %}{% translate "No data." %}{% endif %}</strong>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-cogs"></i> &nbsp; {% translate "Data processing" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Telegrams to consumption" %}</strong>
                                <br><br>

                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}This indicates how many stored telegrams are waiting to be processed.{% endblocktranslate %}
                                        {% blocktranslate %}This should reset around each minute mark, depending on whether you've enabled grouping readings in the configuration.{% endblocktranslate %}
                                        {% blocktranslate %}The stored telegrams are processed by the DSMR_BACKEND process and thus can be processed retroactively as well (by design).{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if status.readings.unprocessed.seconds_since > 300 %}
                                <div class="alert alert-danger" role="alert">
                                    <span class="fas fa-exclamation-triangle"></span> &nbsp;
                                    {% blocktranslate %}There are too many unprocessed telegrams.{% endblocktranslate %}
                                    <br /><br />
                                {% else %}
                                <div class="alert alert-success" role="alert">
                                    <span class="fas fa-check"></span> &nbsp;
                                {% endif %}

                                {% translate "Unprocessed telegrams" %}: <strong>{{ status.readings.unprocessed.count|default:'-' }}</strong>
                            </td>
                        </tr>

                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Calculating electricity consumption" %}</strong>
                                <br><br>

                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}When telegrams are processed, they are split into electricity and gas (when available) consumption nodes.{% endblocktranslate %}
                                        {% blocktranslate %}These consumption nodes are plotted in the graphs displayed on the Dashboard page.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if status.electricity.latest %}
                                    {% if status.electricity.minutes_since == None or status.electricity.minutes_since > 2 %}
                                    <div class="alert alert-danger" role="alert">
                                        <span class="fas fa-exclamation-triangle"></span> &nbsp;
                                        {% translate "Recorded electricity consumption is lagging behind" %}: <strong>{{ status.electricity.latest|naturaltime }}</strong>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-success" role="alert">
                                        <span class="fas fa-check"></span> &nbsp;
                                        {% translate "Recorded electricity consumption is on schedule" %}: <strong>{{ status.electricity.latest|naturaltime }}</strong>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp; {% translate "No data." %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Calculating gas consumption" %}</strong>
                                <br><br>

                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}When telegrams are processed, they are split into electricity and gas (when available) consumption nodes.{% endblocktranslate %}
                                        {% blocktranslate %}These consumption nodes are plotted in the graphs displayed on the Dashboard page.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if capabilities.gas and status.gas.latest %}
                                    {% if status.gas.hours_since == None or status.gas.hours_since > 3 %}
                                    <div class="alert alert-danger" role="alert">
                                        <span class="fas fa-exclamation-triangle"></span> &nbsp;
                                        {% translate "Recorded gas consumption is lagging behind" %}: <strong>{{ status.gas.latest|naturaltime }}</strong>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-success" role="alert">
                                        <span class="fas fa-check"></span> &nbsp;
                                        {% translate "Recorded gas consumption is on schedule" %}: <strong>{{ status.gas.latest|naturaltime }}</strong>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp; {% translate "No data (or manually disabled)" %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Day &amp; hour statistics" %}</strong>
                                <br><br>

                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}At the end of each day (around 1 a.m.) all consumption nodes will be aggregated to statistics nodes.{% endblocktranslate %}
                                        {% blocktranslate %}These statistics nodes consist of daily and hourly consumption totals (due to performance).{% endblocktranslate %}
                                        {% blocktranslate %}They are used in many pages displaying long term data, such as the Archive, Trends and Compare pages.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if status.statistics.days_since == None or status.statistics.days_since > 1 %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp;
                                    {% translate "Data processing is lagging behind" %}:
                                    <strong>{% if status.statistics.latest %}{{ status.statistics.latest }}{% else %}{% translate "No data." %}{% endif %}</strong>
                                </div>
                                {% else %}
                                <div class="alert alert-success" role="alert">
                                    <span class="fas fa-check"></span> &nbsp;
                                    {% translate "Data processing is on schedule" %}: <strong>{{ status.statistics.latest }}</strong>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-cogs"></i> &nbsp; {% translate "Scheduled processes" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">
                    {%  for current in status.scheduled_processes %}
                        <tr>
                            <td class="col-sm-6">
                                <strong>{{ current.name }}</strong>
                            </td>
                            <td class="col-sm-6">
                                {% if current.active %}
                                <div class="alert {% if current.planned >= status.now %}alert-success{% else %}alert-info{% endif %}" role="alert">
                                    {% translate "Last run" %}: <strong>{{ current.last_executed_at|naturaltime|default:'-' }}</strong>
                                    <br>
                                    <small>{% translate "Next run planned" %}: <strong>{{ current.planned|naturaltime|default:'-' }}</strong></small>
                                </div>
                                {% else %}
                                    <small>{% translate "Currently disabled or not configured." %}</small>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-cogs"></i> &nbsp; {% translate "Integrations" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">

                        {% if status.tools.dropbox.enabled %}
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Latest Dropbox sync" %}</strong>
                            </td>
                            <td class="col-sm-6">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info"></i> &nbsp;
                                    {% translate "Latest" %}: <strong>{{ status.tools.dropbox.latest_sync|default:'-' }}</strong>
                                </div>
                            </td>
                        </tr>
                        {% endif %}

                        {% if status.tools.pvoutput.enabled %}
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Latest PVOutput sync" %}</strong>
                            </td>
                            <td class="col-sm-6">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info"></i> &nbsp;
                                    {% translate "Latest" %}: <strong>{{ status.tools.pvoutput.latest_sync|default:'-' }}</strong>
                                </div>
                            </td>
                        </tr>
                        {% endif %}

                        {% if status.tools.mqtt %}
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "MQTT messages sync" %}</strong>
                            </td>
                            <td class="col-sm-6">
                                {% if status.tools.mqtt.ok %}
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check"></i> &nbsp;
                                {% else %}
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% endif %}
                                    {% translate "Pending messages" %}: <strong>{{ status.tools.mqtt.pending_messages }}</strong>
                                </div>
                            </td>
                        </tr>
                        {% endif %}

                        {% if status.tools.influxdb %}
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "InfluxDB measurements sync" %}</strong>
                            </td>
                            <td class="col-sm-6">
                                {% if status.tools.influxdb.ok %}
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check"></i> &nbsp;
                                {% else %}
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% endif %}
                                    {% translate "Pending measurements" %}: <strong>{{ status.tools.influxdb.pending_measurements }}</strong>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <header class="panel-heading">
                    <i class="fas fa-plug"></i> &nbsp; {% translate "Capabilities" %} <br />
                </header>
                <div class="panel-body">
                    <table class="table table-hover">
                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Electricity consumed" %}</strong>
                                <br><br>
                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}The capability nodes reflect the capabilities of your smart meter.{% endblocktranslate %}
                                        {% blocktranslate %}The status of each of these (three) capabilities are displayed here and they determine which graphs are rendered in the application pages.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if capabilities.electricity %}
                                <div class="alert alert-info" role="alert">
                                    <span class="fas fa-check"></span> &nbsp; {% translate "Electricity consumption recorded" %}
                                </div>
                                {% else %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp; {% translate "No electricity consumption recorded" %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Electricity returned" %}</strong>
                                <br><br>
                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}The capability nodes reflect the capabilities of your smart meter.{% endblocktranslate %}
                                        {% blocktranslate %}The status of each of these (three) capabilities are displayed here and they determine which graphs are rendered in the application pages.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if capabilities.electricity_returned %}
                                <div class="alert alert-info" role="alert">
                                    <span class="fas fa-check"></span> &nbsp; {% translate "Electricity return recorded" %}
                                </div>
                                {% else %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp; {% translate "No electricity return recorded (or manually disabled)" %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <td class="col-sm-6">
                                <strong>{% translate "Gas consumed" %}</strong>
                                <br><br>
                                <div>
                                    <a class="help-trigger" href="#"><small>{% translate "Explain" %}</small></a>
                                    <small class="xhr-hidden">
                                        {% blocktranslate %}The capability nodes reflect the capabilities of your smart meter.{% endblocktranslate %}
                                        {% blocktranslate %}The status of each of these (three) capabilities are displayed here and they determine which graphs are rendered in the application pages.{% endblocktranslate %}
                                    </small>
                                </div>
                            </td>
                            <td class="col-sm-6">
                                {% if capabilities.gas %}
                                <div class="alert alert-info" role="alert">
                                    <span class="fas fa-check"></span> &nbsp; {% translate "Gas consumption recorded" %}
                                </div>
                                {% else %}
                                <div class="alert alert-gray" role="alert">
                                    <span class="fas fa-times"></span> &nbsp; {% translate "No gas consumption recorded (or manually disabled)" %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>


</section>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    
	<script type="text/javascript">
	    var status_update_url = "{% url 'frontend:status-xhr-check-for-updates' %}";
	</script>
    <script type="text/javascript" src="{% static 'dsmr_frontend/js/dsmr-reader/status/status.js' %}?r=v{{ dsmr_version }}"></script>
{% endblock %}
